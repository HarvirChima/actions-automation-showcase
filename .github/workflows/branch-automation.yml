# ğŸŒŸ Branch Automation Workflow
# 
# This workflow demonstrates advanced branch automation capabilities:
# - Welcomes new branches with personalized messages
# - Analyzes branch type based on naming conventions
# - Provides smart suggestions based on branch activity
# - Creates helpful documentation for contributors
#
# ğŸ¯ Perfect for onboarding new contributors and maintaining consistency!

name: ğŸŒŸ Branch Automation

# ğŸš€ Trigger conditions
on:
  create:  # ğŸ†• Triggered when a new branch is created
  push:    # ğŸ“¤ Triggered on every push to any branch
    branches:
      - '**'  # All branches (feature/*, bugfix/*, hotfix/*, etc.)

# ğŸ”§ Workflow jobs
jobs:
  # ğŸ¯ Branch Analysis Job
  branch-analysis:
    name: ğŸ” Analyze Branch
    runs-on: ubuntu-latest
    
    # ğŸ›¡ï¸ Only run on branch creation or first push
    if: github.event_name == 'create' || github.event.created
    
    steps:
      # ğŸ“¥ Checkout the repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # ğŸ” Fetch full history for analysis
          fetch-depth: 0
          
      # ğŸ·ï¸ Extract branch information
      - name: ğŸ·ï¸ Extract Branch Info
        id: branch-info
        run: |
          # ğŸ“‹ Get branch name from the ref
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # ğŸ¯ Determine branch type based on naming convention
          case $BRANCH_NAME in
            feature/*)
              echo "branch_type=feature" >> $GITHUB_OUTPUT
              echo "emoji=âœ¨" >> $GITHUB_OUTPUT
              echo "description=Feature Development" >> $GITHUB_OUTPUT
              ;;
            bugfix/*)
              echo "branch_type=bugfix" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ›" >> $GITHUB_OUTPUT
              echo "description=Bug Fix" >> $GITHUB_OUTPUT
              ;;
            hotfix/*)
              echo "branch_type=hotfix" >> $GITHUB_OUTPUT
              echo "emoji=ğŸš¨" >> $GITHUB_OUTPUT
              echo "description=Critical Hotfix" >> $GITHUB_OUTPUT
              ;;
            release/*)
              echo "branch_type=release" >> $GITHUB_OUTPUT
              echo "emoji=ğŸš€" >> $GITHUB_OUTPUT
              echo "description=Release Preparation" >> $GITHUB_OUTPUT
              ;;
            docs/*)
              echo "branch_type=docs" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ“š" >> $GITHUB_OUTPUT
              echo "description=Documentation" >> $GITHUB_OUTPUT
              ;;
            test/*)
              echo "branch_type=test" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ§ª" >> $GITHUB_OUTPUT
              echo "description=Testing" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "branch_type=other" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ”§" >> $GITHUB_OUTPUT
              echo "description=General Development" >> $GITHUB_OUTPUT
              ;;
          esac
          
          # ğŸ‘¤ Get author information
          echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "author_name=$(git log -1 --pretty=format:'%an' 2>/dev/null || echo '${{ github.actor }}')" >> $GITHUB_OUTPUT
          
      # ğŸ¨ Generate branch welcome content
      - name: ğŸ¨ Generate Welcome Content
        id: welcome-content
        run: |
          # ğŸ“ Create personalized welcome message
          cat << 'EOF' > branch-welcome.md
          # ${{ steps.branch-info.outputs.emoji }} Welcome to Branch: `${{ steps.branch-info.outputs.branch_name }}`
          
          **Branch Type:** ${{ steps.branch-info.outputs.description }}  
          **Created by:** @${{ steps.branch-info.outputs.author }}  
          **Created on:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## ğŸ¯ Smart Suggestions for ${{ steps.branch-info.outputs.branch_type }} branches:
          
          EOF
          
          # ğŸ’¡ Add type-specific suggestions
          case "${{ steps.branch-info.outputs.branch_type }}" in
            feature)
              cat << 'FEATURE_EOF' >> branch-welcome.md
          ### âœ¨ Feature Development Best Practices:
          - [ ] ğŸ“‹ Create/update issue linking this feature
          - [ ] ğŸ§ª Write tests for new functionality
          - [ ] ğŸ“š Update documentation
          - [ ] ğŸ” Consider breaking changes
          - [ ] ğŸ¨ Follow UI/UX guidelines
          - [ ] âš¡ Performance considerations
          
          ### ğŸš€ Helpful Commands:
          ```bash
          # Run tests
          npm test
          
          # Start development server
          npm start
          
          # Check code style
          npm run lint
          ```
          FEATURE_EOF
              ;;
            bugfix)
              cat << 'BUGFIX_EOF' >> branch-welcome.md
          ### ğŸ› Bug Fix Guidelines:
          - [ ] ğŸ” Reproduce the issue
          - [ ] ğŸ“‹ Reference the issue number
          - [ ] ğŸ§ª Add regression tests
          - [ ] âœ… Verify fix works
          - [ ] ğŸ“ Update changelog
          - [ ] ğŸ” Check for similar issues
          
          ### ğŸ”§ Debug Commands:
          ```bash
          # Run specific tests
          npm test -- --verbose
          
          # Debug mode
          npm run debug
          ```
          BUGFIX_EOF
              ;;
            hotfix)
              cat << 'HOTFIX_EOF' >> branch-welcome.md
          ### ğŸš¨ Hotfix Priority Actions:
          - [ ] ğŸ”¥ **URGENT**: Verify this is production-critical
          - [ ] ğŸ“ Notify stakeholders
          - [ ] ğŸ§ª Test thoroughly
          - [ ] ğŸ“‹ Update incident documentation
          - [ ] ğŸš€ Plan immediate deployment
          - [ ] ğŸ“Š Monitor post-deployment
          
          ### âš¡ Quick Commands:
          ```bash
          # Quick test
          npm run test:quick
          
          # Production build test
          npm run build
          ```
          HOTFIX_EOF
              ;;
            release)
              cat << 'RELEASE_EOF' >> branch-welcome.md
          ### ğŸš€ Release Preparation Checklist:
          - [ ] ğŸ“‹ Update version numbers
          - [ ] ğŸ“ Update CHANGELOG.md
          - [ ] ğŸ§ª Run full test suite
          - [ ] ğŸ“š Update documentation
          - [ ] ğŸ” Security audit
          - [ ] ğŸ“Š Performance benchmarks
          
          ### ğŸ“¦ Release Commands:
          ```bash
          # Version bump
          npm version patch/minor/major
          
          # Full test suite
          npm run test:all
          
          # Build production
          npm run build:prod
          ```
          RELEASE_EOF
              ;;
            *)
              cat << 'DEFAULT_EOF' >> branch-welcome.md
          ### ğŸ”§ General Development Tips:
          - [ ] ğŸ“‹ Keep commits focused and atomic
          - [ ] ğŸ§ª Run tests frequently
          - [ ] ğŸ“ Write descriptive commit messages
          - [ ] ğŸ” Review your own changes first
          - [ ] ğŸ’¬ Ask for help when needed
          
          ### ğŸ› ï¸ Common Commands:
          ```bash
          # Install dependencies
          npm install
          
          # Run development server
          npm start
          
          # Run tests
          npm test
          ```
          DEFAULT_EOF
              ;;
          esac
          
          # ğŸ‰ Add encouraging footer
          cat << 'FOOTER_EOF' >> branch-welcome.md
          
          ## ğŸ‰ Happy Coding!
          
          This branch was automatically analyzed by our GitHub Actions workflow.  
          For questions or help, feel free to reach out to the team! ğŸ’ª
          
          ---
          
          > ğŸ¤– **Automated by GitHub Actions** | Branch Automation Workflow v1.0
          FOOTER_EOF
          
      # ğŸ’¾ Commit the welcome file
      - name: ğŸ’¾ Create Branch Welcome File
        run: |
          # ğŸ“ Create docs directory if it doesn't exist
          mkdir -p docs/branches
          
          # ğŸ“ Move welcome file to docs
          mv branch-welcome.md "docs/branches/welcome-${{ steps.branch-info.outputs.branch_name }}.md"
          
          # ğŸ“¤ Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # ğŸ“‹ Add and commit
          git add docs/branches/
          git commit -m "${{ steps.branch-info.outputs.emoji }} Welcome ${{ steps.branch-info.outputs.branch_name }} branch

          ğŸ¤– Automated branch analysis and welcome message
          
          Branch Type: ${{ steps.branch-info.outputs.description }}
          Created by: @${{ steps.branch-info.outputs.author }}
          
          This commit was created by the Branch Automation workflow."
          
          # ğŸ“¤ Push changes
          git push
          
      # ğŸ“Š Branch activity analysis
      - name: ğŸ“Š Analyze Branch Activity
        run: |
          echo "ğŸ” Analyzing branch activity patterns..."
          
          # ğŸ“ˆ Basic statistics
          COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
          echo "ğŸ“‹ Total commits: $COMMIT_COUNT"
          
          # ğŸ“ Recent activity
          if [ "$COMMIT_COUNT" -gt "0" ]; then
            echo "ğŸ“… Recent commits:"
            git log --oneline -n 5
          fi
          
          # ğŸ’¡ Generate insights
          echo "ğŸ’¡ Branch Insights:"
          echo "- This is a ${{ steps.branch-info.outputs.description }} branch"
          echo "- Created by @${{ steps.branch-info.outputs.author }}"
          echo "- Total commits: $COMMIT_COUNT"
          
      # ğŸ¯ Create issue for tracking (optional)
      - name: ğŸ¯ Create Tracking Issue
        if: steps.branch-info.outputs.branch_type == 'feature' || steps.branch-info.outputs.branch_type == 'bugfix'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = "${{ steps.branch-info.outputs.branch_name }}";
            const branchType = "${{ steps.branch-info.outputs.branch_type }}";
            const emoji = "${{ steps.branch-info.outputs.emoji }}";
            const author = "${{ steps.branch-info.outputs.author }}";
            
            // ğŸ“‹ Create issue for tracking
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${emoji} Track ${branchType}: ${branchName}`,
              body: `## ${emoji} Branch Tracking Issue
              
              **Branch:** \`${branchName}\`  
              **Type:** ${branchType}  
              **Author:** @${author}  
              **Created:** ${new Date().toISOString()}
              
              ### ğŸ“‹ Progress Checklist:
              - [ ] Initial development
              - [ ] Testing completed
              - [ ] Documentation updated
              - [ ] Code review requested
              - [ ] Ready for merge
              
              ### ğŸ”— Related Links:
              - Branch: [${branchName}](../../tree/${branchName})
              - Welcome Guide: [docs/branches/welcome-${branchName}.md](../../blob/${branchName}/docs/branches/welcome-${branchName}.md)
              
              ---
              
              > ğŸ¤– This issue was automatically created by the Branch Automation workflow.`,
              labels: ['automation', branchType, 'tracking'],
              assignees: [author]
            });
            
            console.log(`ğŸ“‹ Created tracking issue #${issue.data.number}`);