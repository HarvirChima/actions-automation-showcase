# ðŸš€ CI/CD Pipeline Workflow
#
# This workflow demonstrates a comprehensive CI/CD pipeline:
# - Runs tests and builds on push/PR events
# - Multi-environment testing across Node.js versions
# - Security scanning simulation and code quality checks
# - Deployment pipeline demonstration with multiple stages
# - Performance monitoring and artifact management
#
# ðŸŽ¯ Perfect example of modern DevOps practices!

name: ðŸš€ CI/CD Pipeline

# ðŸš€ Trigger conditions
on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:  # ðŸŽ® Manual trigger for demos

# ðŸŒ Environment variables
env:
  NODE_VERSION_MATRIX: '[16, 18, 20]'
  DEPLOY_ENVIRONMENT: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

# ðŸ”§ Workflow jobs
jobs:
  # ðŸ” Pre-flight checks
  pre-flight:
    name: ðŸ” Pre-flight Checks
    runs-on: ubuntu-latest
    outputs:
      should_run_tests: ${{ steps.changes.outputs.should_run_tests }}
      deploy_environment: ${{ steps.env.outputs.deploy_environment }}
      
    steps:
      # ðŸ“¥ Checkout code
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      # ðŸ” Analyze changes
      - name: ðŸ” Analyze Code Changes
        id: changes
        run: |
          echo "ðŸ” Analyzing changes to determine test requirements..."
          
          # ðŸ“Š Check if we need to run tests based on file changes
          if git diff --name-only HEAD~1 HEAD | grep -E '\.(js|ts|json)$' > /dev/null; then
            echo "should_run_tests=true" >> $GITHUB_OUTPUT
            echo "âœ… JavaScript/TypeScript files changed - tests required"
          else
            echo "should_run_tests=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No JavaScript/TypeScript files changed - skipping tests"
          fi
          
      # ðŸŒ Set environment context
      - name: ðŸŒ Set Environment Context
        id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "deploy_environment=production" >> $GITHUB_OUTPUT
            echo "ðŸš€ Production deployment context"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "deploy_environment=staging" >> $GITHUB_OUTPUT
            echo "ðŸ§ª Staging deployment context"
          else
            echo "deploy_environment=review" >> $GITHUB_OUTPUT
            echo "ðŸ‘€ Review deployment context"
          fi
          
  # ðŸ§ª Testing Matrix Job
  test:
    name: ðŸ§ª Test Suite (Node.js ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    needs: pre-flight
    if: needs.pre-flight.outputs.should_run_tests == 'true'
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16, 18, 20]
        # ðŸŽ¯ Allow some failures for experimental setups
        include:
          - os: ubuntu-latest
            node-version: 21
            experimental: true
        exclude:
          # ðŸ’¾ Reduce matrix size for faster execution in demo
          - os: windows-latest
            node-version: 16
          - os: macos-latest
            node-version: 16
            
    continue-on-error: ${{ matrix.experimental == true }}
    
    steps:
      # ðŸ“¥ Checkout repository
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # ðŸŸ¢ Setup Node.js
      - name: ðŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      # ðŸ“¦ Install dependencies
      - name: ðŸ“¦ Install Dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies for Node.js ${{ matrix.node-version }}..."
          npm ci
          echo "âœ… Dependencies installed successfully"
          
      # ðŸ” Lint code
      - name: ðŸ” Lint Code
        run: |
          echo "ðŸ” Running linting checks..."
          npm run lint
          echo "âœ… Linting completed"
          
      # ðŸ§ª Run tests
      - name: ðŸ§ª Run Test Suite
        run: |
          echo "ðŸ§ª Running comprehensive test suite..."
          npm test
          echo "âœ… All tests passed!"
          
      # ðŸ—ï¸ Build application
      - name: ðŸ—ï¸ Build Application
        run: |
          echo "ðŸ—ï¸ Building application..."
          npm run build
          echo "âœ… Build completed successfully"
          
      # ðŸ“Š Performance benchmarks
      - name: ðŸ“Š Performance Benchmarks
        run: |
          echo "ðŸ“Š Running performance benchmarks..."
          echo "ðŸš€ Starting application for benchmark..."
          
          # ðŸŽ¯ Simple performance test
          timeout 10s npm start > app.log 2>&1 &
          APP_PID=$!
          
          sleep 3
          echo "â±ï¸ Measuring startup time and memory usage..."
          
          # ðŸ“ˆ Simulate performance metrics
          echo "Startup time: $(( RANDOM % 3 + 1 )).$(( RANDOM % 100 ))s"
          echo "Memory usage: $(( RANDOM % 50 + 100 ))MB"
          echo "Response time: $(( RANDOM % 100 + 50 ))ms"
          
          # ðŸ§¹ Cleanup
          kill $APP_PID 2>/dev/null || true
          echo "âœ… Performance benchmarks completed"
          
      # ðŸ“Š Upload test results
      - name: ðŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-node${{ matrix.node-version }}
          path: |
            test-results/
            coverage/
            app.log
          retention-days: 30
          
  # ðŸ”’ Security Scanning
  security:
    name: ðŸ”’ Security Scanning
    runs-on: ubuntu-latest
    needs: pre-flight
    
    steps:
      # ðŸ“¥ Checkout code
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # ðŸŸ¢ Setup Node.js
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      # ðŸ“¦ Install dependencies
      - name: ðŸ“¦ Install Dependencies
        run: npm ci
        
      # ðŸ”’ Security audit
      - name: ðŸ”’ NPM Security Audit
        run: |
          echo "ðŸ”’ Running NPM security audit..."
          npm audit --audit-level=moderate || true
          echo "âœ… Security audit completed"
          
      # ðŸ›¡ï¸ Dependency check simulation
      - name: ðŸ›¡ï¸ Dependency Vulnerability Scan
        run: |
          echo "ðŸ›¡ï¸ Scanning dependencies for vulnerabilities..."
          
          # ðŸŽ¯ Simulate security scanning results
          echo "ðŸ“Š Security Scan Results:"
          echo "â”œâ”€â”€ Critical vulnerabilities: 0"
          echo "â”œâ”€â”€ High vulnerabilities: 0"
          echo "â”œâ”€â”€ Medium vulnerabilities: $(( RANDOM % 3 ))"
          echo "â”œâ”€â”€ Low vulnerabilities: $(( RANDOM % 5 ))"
          echo "â””â”€â”€ Total dependencies scanned: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo '0')"
          
          echo "âœ… Vulnerability scan completed"
          
      # ðŸ” Code quality analysis
      - name: ðŸ” Code Quality Analysis
        run: |
          echo "ðŸ” Running code quality analysis..."
          
          # ðŸ“Š Simulate code quality metrics
          echo "ðŸ“Š Code Quality Metrics:"
          echo "â”œâ”€â”€ Code coverage: $(( RANDOM % 20 + 80 ))%"
          echo "â”œâ”€â”€ Maintainability index: $(( RANDOM % 20 + 80 ))/100"
          echo "â”œâ”€â”€ Technical debt: $(( RANDOM % 10 + 5 )) hours"
          echo "â”œâ”€â”€ Duplicated lines: $(( RANDOM % 5 ))%"
          echo "â””â”€â”€ Complexity score: $(( RANDOM % 10 + 1 ))/10"
          
          echo "âœ… Code quality analysis completed"
          
  # ðŸ—ï¸ Build and Package
  build:
    name: ðŸ—ï¸ Build & Package
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    
    steps:
      # ðŸ“¥ Checkout repository
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      # ðŸŸ¢ Setup Node.js
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      # ðŸ“¦ Install dependencies
      - name: ðŸ“¦ Install Dependencies
        run: npm ci
        
      # ðŸ—ï¸ Production build
      - name: ðŸ—ï¸ Create Production Build
        run: |
          echo "ðŸ—ï¸ Creating optimized production build..."
          npm run build
          echo "âœ… Production build created"
          
      # ðŸ“¦ Package application
      - name: ðŸ“¦ Package Application
        run: |
          echo "ðŸ“¦ Packaging application for deployment..."
          
          # ðŸŽ¯ Create deployment package
          mkdir -p dist/
          cp -r node_modules/ dist/ 2>/dev/null || echo "No node_modules to copy"
          cp package*.json dist/
          cp index.js dist/
          cp -r docs/ dist/ 2>/dev/null || echo "No docs to copy"
          
          # ðŸ“Š Package info
          echo "ðŸ“Š Package Information:"
          echo "â”œâ”€â”€ Package size: $(du -sh dist/ | cut -f1)"
          echo "â”œâ”€â”€ Files included: $(find dist/ -type f | wc -l)"
          echo "â”œâ”€â”€ Build timestamp: $(date)"
          echo "â””â”€â”€ Git commit: ${{ github.sha }}"
          
          echo "âœ… Application packaged successfully"
          
      # ðŸ“¤ Upload build artifacts
      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 90
          
  # ðŸš€ Deployment Simulation
  deploy:
    name: ðŸš€ Deploy to ${{ needs.pre-flight.outputs.deploy_environment }}
    runs-on: ubuntu-latest
    needs: [pre-flight, build]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: 
      name: ${{ needs.pre-flight.outputs.deploy_environment }}
      url: https://${{ needs.pre-flight.outputs.deploy_environment }}.example.com
      
    steps:
      # ðŸ“¥ Download build artifacts
      - name: ðŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: ./deploy
          
      # ðŸš€ Deploy to environment
      - name: ðŸš€ Deploy Application
        run: |
          ENVIRONMENT="${{ needs.pre-flight.outputs.deploy_environment }}"
          echo "ðŸš€ Deploying to $ENVIRONMENT environment..."
          
          # ðŸŽ¯ Simulate deployment steps
          echo "ðŸ“‹ Deployment Steps:"
          echo "â”œâ”€â”€ 1. Validating deployment package..."
          sleep 2
          echo "â”œâ”€â”€ 2. Connecting to $ENVIRONMENT servers..."
          sleep 1
          echo "â”œâ”€â”€ 3. Backing up current version..."
          sleep 1
          echo "â”œâ”€â”€ 4. Uploading new version..."
          sleep 3
          echo "â”œâ”€â”€ 5. Running database migrations..."
          sleep 2
          echo "â”œâ”€â”€ 6. Starting application services..."
          sleep 2
          echo "â”œâ”€â”€ 7. Running health checks..."
          sleep 1
          echo "â””â”€â”€ 8. Deployment completed successfully!"
          
          echo "âœ… Application deployed to $ENVIRONMENT"
          echo "ðŸŒ URL: https://$ENVIRONMENT.example.com"
          
      # ðŸ” Post-deployment verification
      - name: ðŸ” Post-deployment Verification
        run: |
          echo "ðŸ” Running post-deployment verification..."
          
          # ðŸ“Š Simulate health checks
          echo "ðŸ“Š Health Check Results:"
          echo "â”œâ”€â”€ Application status: âœ… Running"
          echo "â”œâ”€â”€ Database connectivity: âœ… Connected"
          echo "â”œâ”€â”€ External APIs: âœ… Responding"
          echo "â”œâ”€â”€ Memory usage: $(( RANDOM % 30 + 40 ))%"
          echo "â”œâ”€â”€ CPU usage: $(( RANDOM % 20 + 10 ))%"
          echo "â””â”€â”€ Response time: $(( RANDOM % 100 + 50 ))ms"
          
          echo "âœ… Post-deployment verification completed"
          
      # ðŸ“Š Deployment metrics
      - name: ðŸ“Š Record Deployment Metrics
        run: |
          echo "ðŸ“Š Recording deployment metrics..."
          
          echo "ðŸŽ¯ Deployment Summary:"
          echo "â”œâ”€â”€ Environment: ${{ needs.pre-flight.outputs.deploy_environment }}"
          echo "â”œâ”€â”€ Commit: ${{ github.sha }}"
          echo "â”œâ”€â”€ Branch: ${{ github.ref_name }}"
          echo "â”œâ”€â”€ Triggered by: ${{ github.actor }}"
          echo "â”œâ”€â”€ Deployment time: $(date)"
          echo "â””â”€â”€ Status: âœ… Successful"
          
          echo "ðŸ’¾ Metrics recorded for monitoring dashboard"
          
  # ðŸ“Š Pipeline Summary
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [pre-flight, test, security, build, deploy]
    if: always()
    
    steps:
      # ðŸ“Š Generate pipeline report
      - name: ðŸ“Š Generate Pipeline Report
        run: |
          echo "ðŸ“Š CI/CD Pipeline Summary"
          echo "========================"
          echo "ðŸŽ¯ Pipeline triggered by: ${{ github.event_name }}"
          echo "ðŸ“‹ Branch: ${{ github.ref_name }}"
          echo "ðŸ‘¤ Actor: ${{ github.actor }}"
          echo "ðŸ•’ Started: ${{ github.event.head_commit.timestamp || github.event.pull_request.created_at }}"
          echo "ðŸ“ Commit: ${{ github.sha }}"
          echo ""
          echo "ðŸ” Job Results:"
          echo "â”œâ”€â”€ Pre-flight: ${{ needs.pre-flight.result }}"
          echo "â”œâ”€â”€ Tests: ${{ needs.test.result || 'skipped' }}"
          echo "â”œâ”€â”€ Security: ${{ needs.security.result }}"
          echo "â”œâ”€â”€ Build: ${{ needs.build.result }}"
          echo "â””â”€â”€ Deploy: ${{ needs.deploy.result || 'skipped' }}"
          echo ""
          
          # ðŸŽ¯ Overall pipeline status
          if [[ "${{ needs.test.result }}" == "failure" || "${{ needs.security.result }}" == "failure" || "${{ needs.build.result }}" == "failure" ]]; then
            echo "âŒ Pipeline Status: FAILED"
            echo "ðŸ’¡ Check failed jobs for details"
          elif [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "âœ… Pipeline Status: DEPLOYED"
            echo "ðŸš€ Application successfully deployed to ${{ needs.pre-flight.outputs.deploy_environment }}"
          else
            echo "âœ… Pipeline Status: COMPLETED"
            echo "ðŸ“‹ All checks passed, deployment skipped (not a push to main/develop)"
          fi
          
          echo ""
          echo "ðŸŽ‰ Thanks for contributing to the project!"
          
      # ðŸ’¬ Comment on PR (if applicable)
      - name: ðŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            
            // ðŸŽ¨ Build status summary
            const jobs = {
              'Pre-flight': '${{ needs.pre-flight.result }}',
              'Tests': '${{ needs.test.result || 'skipped' }}',
              'Security': '${{ needs.security.result }}',
              'Build': '${{ needs.build.result }}',
              'Deploy': '${{ needs.deploy.result || 'skipped' }}'
            };
            
            let statusEmoji = 'âœ…';
            let statusText = 'All checks passed!';
            
            for (const [job, result] of Object.entries(jobs)) {
              if (result === 'failure') {
                statusEmoji = 'âŒ';
                statusText = 'Some checks failed';
                break;
              }
            }
            
            const comment = `## ${statusEmoji} CI/CD Pipeline Results
            
            **Status:** ${statusText}
            
            ### ðŸ“Š Job Results:
            ${Object.entries(jobs).map(([job, result]) => {
              const emoji = result === 'success' ? 'âœ…' : 
                           result === 'failure' ? 'âŒ' : 
                           result === 'skipped' ? 'â­ï¸' : 'ðŸ”„';
              return `- ${emoji} **${job}**: ${result}`;
            }).join('\n')}
            
            ### ðŸŽ¯ Pipeline Details:
            - **Commit**: \`${{ github.sha }}\`
            - **Branch**: \`${{ github.ref_name }}\`
            - **Triggered by**: @${{ github.actor }}
            
            ${statusEmoji === 'âœ…' ? 
              'ðŸŽ‰ Great work! Your changes are ready for review.' : 
              'ðŸ” Please check the failed jobs and fix any issues.'
            }
            
            ---
            
            > ðŸ¤– **Automated by CI/CD Pipeline** | View details in the [Actions tab](../../actions)`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            console.log(`ðŸ’¬ Posted pipeline summary to PR #${prNumber}`);
            
  # ðŸ§¹ Cleanup
  cleanup:
    name: ðŸ§¹ Cleanup
    runs-on: ubuntu-latest
    needs: [summary]
    if: always()
    
    steps:
      # ðŸ§¹ Cleanup temporary resources
      - name: ðŸ§¹ Cleanup Resources
        run: |
          echo "ðŸ§¹ Cleaning up temporary resources..."
          echo "â”œâ”€â”€ Removing temporary files..."
          echo "â”œâ”€â”€ Clearing caches..."
          echo "â””â”€â”€ Cleanup completed"
          
          echo "ðŸ’¡ In a real scenario, this might:"
          echo "  - Clean up test environments"
          echo "  - Remove temporary cloud resources"
          echo "  - Archive old artifacts"
          echo "  - Send notifications"