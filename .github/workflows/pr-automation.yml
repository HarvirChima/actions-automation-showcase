# ğŸ·ï¸ Pull Request Automation Workflow
#
# This workflow provides intelligent PR automation:
# - Auto-labels PRs based on file changes and content
# - Analyzes PR size (small, medium, large)
# - Detects documentation, tests, and configuration changes
# - Adds helpful comments with detailed PR analysis
# - Assigns appropriate reviewers based on changes
#
# ğŸ¯ Makes PR management effortless and consistent!

name: ğŸ·ï¸ PR Automation

# ğŸš€ Trigger conditions
on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
    branches: ['main', 'develop']

# ğŸ”§ Workflow jobs
jobs:
  # ğŸ·ï¸ PR Analysis and Labeling Job
  pr-analysis:
    name: ğŸ” Analyze Pull Request
    runs-on: ubuntu-latest
    
    steps:
      # ğŸ“¥ Checkout the repository
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # ğŸ” Fetch the PR branch and base for comparison
          fetch-depth: 0
          
      # ğŸ“Š Analyze PR changes
      - name: ğŸ“Š Analyze PR Changes
        id: pr-analysis
        run: |
          # ğŸ¯ Get PR information
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "base_sha=$BASE_SHA" >> $GITHUB_OUTPUT
          echo "head_sha=$HEAD_SHA" >> $GITHUB_OUTPUT
          
          # ğŸ“ˆ Calculate PR statistics
          CHANGED_FILES=$(git diff --name-only $BASE_SHA...$HEAD_SHA | wc -l)
          ADDITIONS=$(git diff --shortstat $BASE_SHA...$HEAD_SHA | grep -oE '[0-9]+ insertions?' | grep -oE '[0-9]+' || echo "0")
          DELETIONS=$(git diff --shortstat $BASE_SHA...$HEAD_SHA | grep -oE '[0-9]+ deletions?' | grep -oE '[0-9]+' || echo "0")
          
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          
          # ğŸ“ Determine PR size
          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))
          if [ "$TOTAL_CHANGES" -le 50 ]; then
            PR_SIZE="small"
            SIZE_EMOJI="ğŸŸ¢"
            SIZE_COLOR="0e8a16"
          elif [ "$TOTAL_CHANGES" -le 200 ]; then
            PR_SIZE="medium"
            SIZE_EMOJI="ğŸŸ¡"
            SIZE_COLOR="fbca04"
          else
            PR_SIZE="large"
            SIZE_EMOJI="ğŸ”´"
            SIZE_COLOR="d73a4a"
          fi
          
          echo "pr_size=$PR_SIZE" >> $GITHUB_OUTPUT
          echo "size_emoji=$SIZE_EMOJI" >> $GITHUB_OUTPUT
          echo "size_color=$SIZE_COLOR" >> $GITHUB_OUTPUT
          
          # ğŸ“‹ Analyze file types and patterns
          git diff --name-only $BASE_SHA...$HEAD_SHA > changed_files.txt
          
          # ğŸ” Detect change categories
          HAS_DOCS=$(grep -E '\.(md|rst|txt)$|^docs/' changed_files.txt | wc -l)
          HAS_TESTS=$(grep -E '\.test\.|\.spec\.|test/|tests/|__tests__/' changed_files.txt | wc -l)
          HAS_CONFIG=$(grep -E '\.(json|yml|yaml|toml|ini|cfg)$|\.config\.|\.env' changed_files.txt | wc -l)
          HAS_FRONTEND=$(grep -E '\.(js|ts|jsx|tsx|vue|css|scss|html)$' changed_files.txt | wc -l)
          HAS_BACKEND=$(grep -E '\.(py|java|go|rb|php|cs|cpp|c)$' changed_files.txt | wc -l)
          HAS_WORKFLOWS=$(grep -E '\.github/workflows/' changed_files.txt | wc -l)
          HAS_DEPENDENCIES=$(grep -E 'package\.json|requirements\.txt|Gemfile|go\.mod|pom\.xml' changed_files.txt | wc -l)
          
          echo "has_docs=$HAS_DOCS" >> $GITHUB_OUTPUT
          echo "has_tests=$HAS_TESTS" >> $GITHUB_OUTPUT
          echo "has_config=$HAS_CONFIG" >> $GITHUB_OUTPUT
          echo "has_frontend=$HAS_FRONTEND" >> $GITHUB_OUTPUT
          echo "has_backend=$HAS_BACKEND" >> $GITHUB_OUTPUT
          echo "has_workflows=$HAS_WORKFLOWS" >> $GITHUB_OUTPUT
          echo "has_dependencies=$HAS_DEPENDENCIES" >> $GITHUB_OUTPUT
          
          # ğŸ¯ Determine primary change type
          if [ "$HAS_WORKFLOWS" -gt "0" ]; then
            PRIMARY_TYPE="workflow"
          elif [ "$HAS_TESTS" -gt "0" ] && [ "$HAS_TESTS" -ge "$HAS_FRONTEND" ] && [ "$HAS_TESTS" -ge "$HAS_BACKEND" ]; then
            PRIMARY_TYPE="testing"
          elif [ "$HAS_DOCS" -gt "0" ] && [ "$HAS_DOCS" -ge "$HAS_FRONTEND" ] && [ "$HAS_DOCS" -ge "$HAS_BACKEND" ]; then
            PRIMARY_TYPE="documentation"
          elif [ "$HAS_CONFIG" -gt "0" ] && [ "$HAS_CONFIG" -ge "$HAS_FRONTEND" ] && [ "$HAS_CONFIG" -ge "$HAS_BACKEND" ]; then
            PRIMARY_TYPE="configuration"
          elif [ "$HAS_FRONTEND" -gt "0" ] && [ "$HAS_FRONTEND" -gt "$HAS_BACKEND" ]; then
            PRIMARY_TYPE="frontend"
          elif [ "$HAS_BACKEND" -gt "0" ]; then
            PRIMARY_TYPE="backend"
          else
            PRIMARY_TYPE="general"
          fi
          
          echo "primary_type=$PRIMARY_TYPE" >> $GITHUB_OUTPUT
          
      # ğŸ·ï¸ Auto-label the PR
      - name: ğŸ·ï¸ Apply Auto Labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-analysis.outputs.pr_number }};
            const labels = [];
            
            // ğŸ“ Size label
            const sizeLabel = `size/${{ steps.pr-analysis.outputs.pr_size }}`;
            labels.push(sizeLabel);
            
            // ğŸ¯ Type-based labels
            if (${{ steps.pr-analysis.outputs.has_docs }} > 0) {
              labels.push('ğŸ“š documentation');
            }
            if (${{ steps.pr-analysis.outputs.has_tests }} > 0) {
              labels.push('ğŸ§ª testing');
            }
            if (${{ steps.pr-analysis.outputs.has_config }} > 0) {
              labels.push('âš™ï¸ configuration');
            }
            if (${{ steps.pr-analysis.outputs.has_frontend }} > 0) {
              labels.push('ğŸ¨ frontend');
            }
            if (${{ steps.pr-analysis.outputs.has_backend }} > 0) {
              labels.push('âš¡ backend');
            }
            if (${{ steps.pr-analysis.outputs.has_workflows }} > 0) {
              labels.push('ğŸ¤– workflow');
            }
            if (${{ steps.pr-analysis.outputs.has_dependencies }} > 0) {
              labels.push('ğŸ“¦ dependencies');
            }
            
            // ğŸš¨ Special attention labels
            if (${{ steps.pr-analysis.outputs.changed_files }} > 20) {
              labels.push('ğŸ” needs-careful-review');
            }
            if (${{ steps.pr-analysis.outputs.additions }} > 500) {
              labels.push('ğŸ“ˆ large-addition');
            }
            if (${{ steps.pr-analysis.outputs.deletions }} > 100) {
              labels.push('ğŸ—‘ï¸ large-deletion');
            }
            
            // ğŸ¯ Primary type label
            const primaryType = '${{ steps.pr-analysis.outputs.primary_type }}';
            if (primaryType !== 'general') {
              labels.push(`type:${primaryType}`);
            }
            
            // ğŸ“‹ Apply labels
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: labels
            });
            
            console.log(`ğŸ·ï¸ Applied labels: ${labels.join(', ')}`);
            
      # ğŸ’¬ Generate analysis comment
      - name: ğŸ’¬ Post Analysis Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-analysis.outputs.pr_number }};
            const sizeEmoji = '${{ steps.pr-analysis.outputs.size_emoji }}';
            const prSize = '${{ steps.pr-analysis.outputs.pr_size }}';
            const changedFiles = ${{ steps.pr-analysis.outputs.changed_files }};
            const additions = ${{ steps.pr-analysis.outputs.additions }};
            const deletions = ${{ steps.pr-analysis.outputs.deletions }};
            const primaryType = '${{ steps.pr-analysis.outputs.primary_type }}';
            
            // ğŸ¨ Build change summary
            let changeSummary = [];
            if (${{ steps.pr-analysis.outputs.has_frontend }} > 0) changeSummary.push('ğŸ¨ Frontend');
            if (${{ steps.pr-analysis.outputs.has_backend }} > 0) changeSummary.push('âš¡ Backend');
            if (${{ steps.pr-analysis.outputs.has_docs }} > 0) changeSummary.push('ğŸ“š Documentation');
            if (${{ steps.pr-analysis.outputs.has_tests }} > 0) changeSummary.push('ğŸ§ª Tests');
            if (${{ steps.pr-analysis.outputs.has_config }} > 0) changeSummary.push('âš™ï¸ Configuration');
            if (${{ steps.pr-analysis.outputs.has_workflows }} > 0) changeSummary.push('ğŸ¤– Workflows');
            if (${{ steps.pr-analysis.outputs.has_dependencies }} > 0) changeSummary.push('ğŸ“¦ Dependencies');
            
            // ğŸ’¡ Generate recommendations
            let recommendations = [];
            
            if (prSize === 'large') {
              recommendations.push('ğŸ” Consider breaking this into smaller PRs for easier review');
            }
            if (${{ steps.pr-analysis.outputs.has_tests }} === 0 && (${{ steps.pr-analysis.outputs.has_frontend }} > 0 || ${{ steps.pr-analysis.outputs.has_backend }} > 0)) {
              recommendations.push('ğŸ§ª Consider adding tests for new functionality');
            }
            if (${{ steps.pr-analysis.outputs.has_docs }} === 0 && changedFiles > 5) {
              recommendations.push('ğŸ“š Consider updating documentation for these changes');
            }
            if (deletions > additions * 2) {
              recommendations.push('ğŸ—‘ï¸ Large deletion detected - please confirm this is intentional');
            }
            if (${{ steps.pr-analysis.outputs.has_dependencies }} > 0) {
              recommendations.push('ğŸ“¦ Dependencies changed - please verify security and compatibility');
            }
            
            // ğŸ‘¥ Suggest reviewers based on changes
            let reviewerSuggestions = [];
            if (primaryType === 'frontend') {
              reviewerSuggestions.push('Consider requesting review from frontend team members');
            }
            if (primaryType === 'backend') {
              reviewerSuggestions.push('Consider requesting review from backend team members');
            }
            if (primaryType === 'workflow') {
              reviewerSuggestions.push('Consider requesting review from DevOps/automation team');
            }
            if (primaryType === 'documentation') {
              reviewerSuggestions.push('Consider requesting review from technical writers');
            }
            
            // ğŸ“ Build comment
            const comment = `## ${sizeEmoji} PR Analysis Report
            
            **Size:** ${prSize} (${changedFiles} files, +${additions}/-${deletions} lines)  
            **Primary Type:** ${primaryType}  
            **Areas Changed:** ${changeSummary.join(', ') || 'General changes'}
            
            ### ğŸ“Š Change Breakdown:
            - ğŸ“ **Files changed:** ${changedFiles}
            - â• **Lines added:** ${additions}
            - â– **Lines removed:** ${deletions}
            - ğŸ¯ **Net change:** ${additions - deletions} lines
            
            ### ğŸ” Detected Changes:
            ${changeSummary.length > 0 ? changeSummary.map(item => `- ${item}`).join('\n') : '- General code changes'}
            
            ${recommendations.length > 0 ? `### ğŸ’¡ Recommendations:
            ${recommendations.map(rec => `- ${rec}`).join('\n')}` : ''}
            
            ${reviewerSuggestions.length > 0 ? `### ğŸ‘¥ Reviewer Suggestions:
            ${reviewerSuggestions.map(sug => `- ${sug}`).join('\n')}` : ''}
            
            ### ğŸ“‹ Review Checklist:
            - [ ] Code follows project standards
            - [ ] Tests are included and passing
            - [ ] Documentation is updated
            - [ ] No breaking changes (or properly documented)
            - [ ] Security considerations reviewed
            
            ---
            
            > ğŸ¤– **Automated by PR Automation Workflow** | This analysis helps streamline the review process!`;
            
            // ğŸ“¤ Post the comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });
            
            console.log('ğŸ’¬ Posted PR analysis comment');
            
      # ğŸ¯ Auto-assign reviewers (optional)
      - name: ğŸ¯ Auto-assign Reviewers
        if: steps.pr-analysis.outputs.pr_size != 'large'  # Only auto-assign for smaller PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-analysis.outputs.pr_number }};
            const primaryType = '${{ steps.pr-analysis.outputs.primary_type }}';
            const author = context.payload.pull_request.user.login;
            
            // ğŸ‘¥ Define reviewer mapping (customize for your team)
            const reviewerMap = {
              'frontend': ['@frontend-team'],
              'backend': ['@backend-team'],
              'workflow': ['@devops-team'],
              'documentation': ['@docs-team'],
              'testing': ['@qa-team']
            };
            
            // ğŸ¯ Get suggested reviewers (excluding author)
            let suggestedReviewers = reviewerMap[primaryType] || [];
            
            // ğŸ“ Note: This is a demo - in real usage, you'd have actual usernames
            console.log(`ğŸ¯ Would suggest reviewers for ${primaryType}: ${suggestedReviewers.join(', ')}`);
            console.log(`ğŸ“‹ PR author: ${author}`);
            console.log('ğŸ’¡ In a real scenario, configure actual team member usernames');
            
      # ğŸ“ˆ Track PR metrics
      - name: ğŸ“ˆ Track PR Metrics
        run: |
          echo "ğŸ“Š PR Metrics Summary:"
          echo "â”œâ”€â”€ Size: ${{ steps.pr-analysis.outputs.pr_size }} ${{ steps.pr-analysis.outputs.size_emoji }}"
          echo "â”œâ”€â”€ Files: ${{ steps.pr-analysis.outputs.changed_files }}"
          echo "â”œâ”€â”€ Additions: +${{ steps.pr-analysis.outputs.additions }}"
          echo "â”œâ”€â”€ Deletions: -${{ steps.pr-analysis.outputs.deletions }}"
          echo "â”œâ”€â”€ Primary Type: ${{ steps.pr-analysis.outputs.primary_type }}"
          echo "â””â”€â”€ Author: ${{ github.actor }}"
          
          # ğŸ’¾ Store metrics for weekly stats (could be enhanced to write to file/database)
          echo "ğŸ’¾ Metrics stored for weekly reporting"