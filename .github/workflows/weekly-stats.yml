# ğŸ“Š Weekly Stats Workflow
#
# This workflow generates comprehensive weekly activity reports:
# - Collects commit statistics and top contributors
# - Analyzes activity patterns and trends
# - Creates issues with weekly highlights and achievements
# - Provides insights for team productivity
# - Can be manually triggered for demos and on-demand reports
#
# ğŸ¯ Perfect for team retrospectives and progress tracking!

name: ğŸ“Š Weekly Stats

# ğŸš€ Trigger conditions
on:
  schedule:
    # ğŸ“… Run every Monday at 9:00 AM UTC (customize as needed)
    - cron: '0 9 * * 1'
  workflow_dispatch:  # ğŸ® Allow manual triggering for demos
    inputs:
      days_back:
        description: 'ğŸ“… Number of days to analyze (default: 7)'
        required: false
        default: '7'
        type: string
      include_stats:
        description: 'ğŸ“Š Include detailed statistics'
        required: false
        default: true
        type: boolean

# ğŸ” Required permissions for this workflow
permissions:
  contents: read  # ğŸ“– Read repository contents and history
  issues: write   # ğŸ“Š Create weekly report issues

# ğŸ”§ Workflow jobs
jobs:
  # ğŸ“ˆ Generate Weekly Report
  weekly-report:
    name: ğŸ“Š Generate Team Weekly Report
    runs-on: ubuntu-latest
    
    steps:
      # ğŸ“¥ Checkout repository with full history
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # ğŸ” Fetch full history for comprehensive analysis
          fetch-depth: 0
          
      # âš™ï¸ Setup analysis parameters
      - name: âš™ï¸ Setup Analysis Parameters
        id: setup
        run: |
          # ğŸ“… Calculate analysis period
          DAYS_BACK="${{ github.event.inputs.days_back || '7' }}"
          INCLUDE_STATS="${{ github.event.inputs.include_stats || 'true' }}"
          
          # ğŸ•’ Calculate date range
          END_DATE=$(date '+%Y-%m-%d')
          START_DATE=$(date -d "$DAYS_BACK days ago" '+%Y-%m-%d')
          
          echo "days_back=$DAYS_BACK" >> $GITHUB_OUTPUT
          echo "include_stats=$INCLUDE_STATS" >> $GITHUB_OUTPUT
          echo "start_date=$START_DATE" >> $GITHUB_OUTPUT
          echo "end_date=$END_DATE" >> $GITHUB_OUTPUT
          
          # ğŸ“‹ Report metadata
          REPORT_WEEK=$(date '+Week %V, %Y')
          REPORT_TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "report_week=$REPORT_WEEK" >> $GITHUB_OUTPUT
          echo "report_timestamp=$REPORT_TIMESTAMP" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Analyzing period: $START_DATE to $END_DATE ($DAYS_BACK days)"
          
      # ğŸ“Š Collect Git Statistics
      - name: ğŸ“Š Collect Git Statistics
        id: git-stats
        run: |
          START_DATE="${{ steps.setup.outputs.start_date }}"
          DAYS_BACK="${{ steps.setup.outputs.days_back }}"
          
          echo "ğŸ” Collecting git statistics for the last $DAYS_BACK days..."
          
          # ğŸ“ˆ Basic commit statistics
          TOTAL_COMMITS=$(git rev-list --since="$DAYS_BACK days ago" --count HEAD 2>/dev/null || echo "0")
          TOTAL_AUTHORS=$(git shortlog --since="$DAYS_BACK days ago" -sn HEAD 2>/dev/null | wc -l || echo "0")
          
          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "total_authors=$TOTAL_AUTHORS" >> $GITHUB_OUTPUT
          
          # ğŸ‘¥ Top contributors (last 7 days)
          echo "ğŸ† Top Contributors:" > weekly_stats.md
          if [ "$TOTAL_COMMITS" -gt "0" ]; then
            git shortlog --since="$DAYS_BACK days ago" -sn HEAD | head -5 | while read count author; do
              echo "- **$author**: $count commits" >> weekly_stats.md
            done
          else
            echo "- No commits in the analyzed period" >> weekly_stats.md
          fi
          
          # ğŸ“… Daily activity breakdown
          echo -e "\nğŸ“… Daily Activity:" >> weekly_stats.md
          for i in $(seq 0 $((DAYS_BACK-1))); do
            DATE=$(date -d "$i days ago" '+%Y-%m-%d')
            DAY_NAME=$(date -d "$i days ago" '+%A')
            DAILY_COMMITS=$(git rev-list --since="$DATE 00:00:00" --until="$DATE 23:59:59" --count HEAD 2>/dev/null || echo "0")
            echo "- **$DAY_NAME ($DATE)**: $DAILY_COMMITS commits" >> weekly_stats.md
          done
          
          # ğŸ“Š File change statistics
          echo -e "\nğŸ“ File Change Summary:" >> weekly_stats.md
          if [ "$TOTAL_COMMITS" -gt "0" ]; then
            TOTAL_ADDITIONS=$(git log --since="$DAYS_BACK days ago" --pretty=tformat: --numstat | awk '{add+=$1} END {print add+0}')
            TOTAL_DELETIONS=$(git log --since="$DAYS_BACK days ago" --pretty=tformat: --numstat | awk '{del+=$2} END {print del+0}')
            FILES_CHANGED=$(git log --since="$DAYS_BACK days ago" --name-only --pretty=format: | sort -u | wc -l)
            
            echo "- **Lines added**: +$TOTAL_ADDITIONS" >> weekly_stats.md
            echo "- **Lines removed**: -$TOTAL_DELETIONS" >> weekly_stats.md
            echo "- **Files changed**: $FILES_CHANGED" >> weekly_stats.md
            echo "- **Net change**: $((TOTAL_ADDITIONS - TOTAL_DELETIONS)) lines" >> weekly_stats.md
            
            echo "total_additions=$TOTAL_ADDITIONS" >> $GITHUB_OUTPUT
            echo "total_deletions=$TOTAL_DELETIONS" >> $GITHUB_OUTPUT
            echo "files_changed=$FILES_CHANGED" >> $GITHUB_OUTPUT
          else
            echo "- No file changes in the analyzed period" >> weekly_stats.md
            echo "total_additions=0" >> $GITHUB_OUTPUT
            echo "total_deletions=0" >> $GITHUB_OUTPUT
            echo "files_changed=0" >> $GITHUB_OUTPUT
          fi
          
      # ğŸ¯ Analyze Activity Patterns
      - name: ğŸ¯ Analyze Activity Patterns
        id: activity-patterns
        run: |
          TOTAL_COMMITS="${{ steps.git-stats.outputs.total_commits }}"
          DAYS_BACK="${{ steps.setup.outputs.days_back }}"
          
          echo "ğŸ” Analyzing activity patterns..."
          
          # ğŸ•’ Time-based analysis
          echo -e "\nâ° Activity Patterns:" >> weekly_stats.md
          
          if [ "$TOTAL_COMMITS" -gt "0" ]; then
            # ğŸ“Š Hour distribution (simplified)
            echo "- **Peak activity hours**: Based on commit timestamps" >> weekly_stats.md
            
            # ğŸ“ˆ Weekday vs Weekend
            WEEKDAY_COMMITS=$(git log --since="$DAYS_BACK days ago" --pretty=format:'%ad' --date=format:'%u' | grep -c '[1-5]' || echo "0")
            WEEKEND_COMMITS=$(git log --since="$DAYS_BACK days ago" --pretty=format:'%ad' --date=format:'%u' | grep -c '[67]' || echo "0")
            
            echo "- **Weekday commits**: $WEEKDAY_COMMITS" >> weekly_stats.md
            echo "- **Weekend commits**: $WEEKEND_COMMITS" >> weekly_stats.md
            
            # ğŸ¯ Activity intensity
            AVG_COMMITS_PER_DAY=$(echo "scale=1; $TOTAL_COMMITS / $DAYS_BACK" | bc 2>/dev/null || echo "0")
            echo "- **Average commits per day**: $AVG_COMMITS_PER_DAY" >> weekly_stats.md
            
            echo "weekday_commits=$WEEKDAY_COMMITS" >> $GITHUB_OUTPUT
            echo "weekend_commits=$WEEKEND_COMMITS" >> $GITHUB_OUTPUT
            echo "avg_commits_per_day=$AVG_COMMITS_PER_DAY" >> $GITHUB_OUTPUT
          else
            echo "- No activity to analyze in this period" >> weekly_stats.md
            echo "weekday_commits=0" >> $GITHUB_OUTPUT
            echo "weekend_commits=0" >> $GITHUB_OUTPUT
            echo "avg_commits_per_day=0" >> $GITHUB_OUTPUT
          fi
          
      # ğŸ† Generate Achievements and Highlights
      - name: ğŸ† Generate Achievements
        id: achievements
        run: |
          TOTAL_COMMITS="${{ steps.git-stats.outputs.total_commits }}"
          TOTAL_AUTHORS="${{ steps.git-stats.outputs.total_authors }}"
          TOTAL_ADDITIONS="${{ steps.git-stats.outputs.total_additions }}"
          FILES_CHANGED="${{ steps.git-stats.outputs.files_changed }}"
          
          echo "ğŸ† Generating team achievements..."
          
          # ğŸŒŸ Generate achievements based on activity
          echo -e "\nğŸ† Weekly Achievements:" >> weekly_stats.md
          
          achievements=()
          
          # ğŸ“Š Commit-based achievements
          if [ "$TOTAL_COMMITS" -gt "50" ]; then
            achievements+=("ğŸš€ **High Velocity Team** - Over 50 commits this week!")
          elif [ "$TOTAL_COMMITS" -gt "20" ]; then
            achievements+=("âš¡ **Active Development** - Great coding momentum!")
          elif [ "$TOTAL_COMMITS" -gt "5" ]; then
            achievements+=("ğŸ“ˆ **Steady Progress** - Consistent development pace!")
          fi
          
          # ğŸ‘¥ Collaboration achievements
          if [ "$TOTAL_AUTHORS" -gt "5" ]; then
            achievements+=("ğŸ‘¥ **Strong Collaboration** - Multiple team members contributing!")
          elif [ "$TOTAL_AUTHORS" -gt "2" ]; then
            achievements+=("ğŸ¤ **Team Effort** - Great teamwork this week!")
          fi
          
          # ğŸ“ Code quality achievements
          if [ "$TOTAL_ADDITIONS" -gt "1000" ]; then
            achievements+=("ğŸ“ **Significant Development** - Major code contributions!")
          fi
          
          if [ "$FILES_CHANGED" -gt "50" ]; then
            achievements+=("ğŸ”„ **Comprehensive Changes** - Wide-ranging improvements!")
          fi
          
          # ğŸ¯ Special achievements
          achievements+=("ğŸŒŸ **Weekly Report Generated** - Keeping track of our progress!")
          
          # ğŸ“‹ Add achievements to report
          if [ ${#achievements[@]} -gt 0 ]; then
            for achievement in "${achievements[@]}"; do
              echo "- $achievement" >> weekly_stats.md
            done
          else
            echo "- ğŸŒ± **Building Momentum** - Every journey starts with a single step!" >> weekly_stats.md
          fi
          
          # ğŸ¯ Set achievement count for issue creation
          echo "achievement_count=${#achievements[@]}" >> $GITHUB_OUTPUT
          
      # ğŸ’¡ Generate Insights and Recommendations
      - name: ğŸ’¡ Generate Insights
        run: |
          TOTAL_COMMITS="${{ steps.git-stats.outputs.total_commits }}"
          TOTAL_AUTHORS="${{ steps.git-stats.outputs.total_authors }}"
          AVG_COMMITS="${{ steps.activity-patterns.outputs.avg_commits_per_day }}"
          WEEKDAY_COMMITS="${{ steps.activity-patterns.outputs.weekday_commits }}"
          WEEKEND_COMMITS="${{ steps.activity-patterns.outputs.weekend_commits }}"
          
          echo "ğŸ’¡ Generating insights and recommendations..."
          
          echo -e "\nğŸ’¡ Insights & Recommendations:" >> weekly_stats.md
          
          # ğŸ“Š Activity analysis
          if [ "$TOTAL_COMMITS" -eq "0" ]; then
            echo "- ğŸŒ± **Getting Started**: Consider setting up regular development schedules" >> weekly_stats.md
            echo "- ğŸ“‹ **Next Steps**: Plan some initial features or improvements" >> weekly_stats.md
          elif [ "$TOTAL_COMMITS" -lt "10" ]; then
            echo "- ğŸ“ˆ **Growth Opportunity**: Consider increasing development frequency" >> weekly_stats.md
            echo "- ğŸ¯ **Focus Areas**: Identify key features to prioritize" >> weekly_stats.md
          else
            echo "- âœ… **Great Activity**: Excellent development momentum!" >> weekly_stats.md
            echo "- ğŸ”„ **Keep It Up**: Maintain this productive pace" >> weekly_stats.md
          fi
          
          # ğŸ‘¥ Team collaboration insights
          if [ "$TOTAL_AUTHORS" -eq "1" ]; then
            echo "- ğŸ¤ **Collaboration**: Consider encouraging more team participation" >> weekly_stats.md
          elif [ "$TOTAL_AUTHORS" -gt "3" ]; then
            echo "- ğŸŒŸ **Excellent Teamwork**: Great collaborative development!" >> weekly_stats.md
          fi
          
          # â° Time pattern insights
          if [ "$WEEKEND_COMMITS" -gt "$WEEKDAY_COMMITS" ]; then
            echo "- âš–ï¸ **Work-Life Balance**: Most activity on weekends - consider work distribution" >> weekly_stats.md
          fi
          
          # ğŸ¯ General recommendations
          echo "- ğŸ“Š **Regular Monitoring**: Keep tracking progress with weekly reports" >> weekly_stats.md
          echo "- ğŸ‰ **Celebrate Wins**: Acknowledge team achievements and milestones" >> weekly_stats.md
          echo "- ğŸš€ **Continuous Improvement**: Use insights to optimize development process" >> weekly_stats.md
          
      # ğŸ“ Create Weekly Report Issue
      - name: ğŸ“ Create Weekly Report Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // ğŸ“Š Read the generated stats
            const statsContent = fs.readFileSync('weekly_stats.md', 'utf8');
            
            // ğŸ“‹ Get report metadata
            const reportWeek = '${{ steps.setup.outputs.report_week }}';
            const reportTimestamp = '${{ steps.setup.outputs.report_timestamp }}';
            const daysBack = '${{ steps.setup.outputs.days_back }}';
            const totalCommits = '${{ steps.git-stats.outputs.total_commits }}';
            const totalAuthors = '${{ steps.git-stats.outputs.total_authors }}';
            const achievementCount = '${{ steps.achievements.outputs.achievement_count }}';
            
            // ğŸ¨ Build comprehensive report
            const reportTitle = `ğŸ“Š Weekly Team Report - ${reportWeek}`;
            
            const reportBody = `# ğŸ“Š Weekly Team Report
            
            **Report Period:** ${reportWeek} (Last ${daysBack} days)  
            **Generated:** ${reportTimestamp}  
            **Total Activity:** ${totalCommits} commits by ${totalAuthors} contributors
            
            ## ğŸ“ˆ Executive Summary
            
            ${totalCommits > 20 ? 'ğŸš€ **High Activity Week**' : totalCommits > 5 ? 'ğŸ“ˆ **Steady Progress**' : 'ğŸŒ± **Building Momentum**'} - This week saw ${totalCommits} commits from ${totalAuthors} team member${totalAuthors !== '1' ? 's' : ''}, demonstrating ${totalCommits > 10 ? 'excellent' : 'good'} development momentum.
            
            ${statsContent}
            
            ## ğŸ¯ Key Metrics Dashboard
            
            | Metric | Value | Trend |
            |--------|-------|-------|
            | ğŸ“‹ Total Commits | ${totalCommits} | ${totalCommits > 20 ? 'ğŸ“ˆ High' : totalCommits > 5 ? 'ğŸ“Š Steady' : 'ğŸ“‰ Low'} |
            | ğŸ‘¥ Active Contributors | ${totalAuthors} | ${totalAuthors > 3 ? 'ğŸŒŸ Excellent' : totalAuthors > 1 ? 'ğŸ‘ Good' : 'ğŸ’¡ Growing'} |
            | ğŸ† Achievements Unlocked | ${achievementCount} | ğŸ‰ Celebrating |
            | ğŸ“Š Average Daily Commits | ${{ steps.activity-patterns.outputs.avg_commits_per_day }} | ğŸ“ˆ Tracking |
            
            ## ğŸ¯ Action Items for Next Week
            
            Based on this week's analysis, here are some suggestions for the upcoming week:
            
            - [ ] ğŸ“‹ **Review Progress**: Assess completed work and plan next priorities
            - [ ] ğŸ¯ **Set Goals**: Define clear objectives for the coming week
            - [ ] ğŸ¤ **Team Sync**: Share insights and coordinate efforts
            - [ ] ğŸ“Š **Monitor Trends**: Keep an eye on productivity patterns
            - [ ] ğŸ‰ **Celebrate**: Acknowledge team achievements and progress
            
            ## ğŸš€ Looking Ahead
            
            ${totalCommits > 15 ? 
              'Excellent momentum this week! Keep up the fantastic work and maintain this productive pace.' : 
              totalCommits > 5 ? 
                'Good progress this week! Consider identifying opportunities to increase development velocity.' :
                'Building momentum! Focus on consistent daily progress and team collaboration.'
            }
            
            ---
            
            > ğŸ¤– **Automated Weekly Report** | Generated by GitHub Actions Weekly Stats Workflow  
            > ğŸ“… **Next Report**: ${new Date(Date.now() + 7*24*60*60*1000).toLocaleDateString()}  
            > ğŸ”„ **Manual Trigger**: Use "Run workflow" for on-demand reports
            
            ## ğŸ“Š Report Configuration
            
            - **Analysis Period**: ${daysBack} days
            - **Include Detailed Stats**: ${{ steps.setup.outputs.include_stats }}
            - **Generated Via**: ${{ github.event_name === 'workflow_dispatch' ? 'Manual Trigger' : 'Scheduled Run' }}
            `;
            
            // ğŸ“ Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: reportTitle,
              body: reportBody,
              labels: ['ğŸ“Š weekly-report', 'ğŸ¤– automation', 'ğŸ“ˆ analytics'],
              assignees: [] // Could assign to team leads
            });
            
            console.log(`ğŸ“ Created weekly report issue #${issue.data.number}`);
            
            // ğŸ¯ Also create a summary comment on the issue
            const summaryComment = `## ğŸ¯ Quick Summary
            
            This week's highlights:
            - ğŸ“Š **${totalCommits} commits** from **${totalAuthors} contributors**
            - ğŸ† **${achievementCount} achievements** unlocked
            - ğŸ“ˆ **${{ steps.activity-patterns.outputs.avg_commits_per_day }}** average daily commits
            
            ${totalCommits > 20 ? 'ğŸš€ Outstanding week!' : totalCommits > 5 ? 'ğŸ‘ Great progress!' : 'ğŸŒ± Keep building!'}
            
            ---
            
            > ğŸ“‹ Use this issue to track weekly goals and discuss team progress!`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: summaryComment
            });
            
      # ğŸ“Š Generate Analytics Summary
      - name: ğŸ“Š Analytics Summary
        run: |
          echo "ğŸ“Š Weekly Analytics Summary"
          echo "=========================="
          echo "ğŸ“… Report Week: ${{ steps.setup.outputs.report_week }}"
          echo "ğŸ“ˆ Total Commits: ${{ steps.git-stats.outputs.total_commits }}"
          echo "ğŸ‘¥ Contributors: ${{ steps.git-stats.outputs.total_authors }}"
          echo "ğŸ“ Lines Added: +${{ steps.git-stats.outputs.total_additions }}"
          echo "ğŸ—‘ï¸ Lines Removed: -${{ steps.git-stats.outputs.total_deletions }}"
          echo "ğŸ“ Files Changed: ${{ steps.git-stats.outputs.files_changed }}"
          echo "ğŸ† Achievements: ${{ steps.achievements.outputs.achievement_count }}"
          echo "âš¡ Avg Daily Commits: ${{ steps.activity-patterns.outputs.avg_commits_per_day }}"
          echo ""
          echo "ğŸ¯ Report successfully generated and posted as GitHub issue!"
          echo "ğŸ“Š Use this data for team retrospectives and planning sessions."